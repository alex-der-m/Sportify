﻿@{
    ViewData["Title"] = "Home Page";
}
@{
     var isAuthenticated = User.Identity.IsAuthenticated;
}

<div id="carouselClasses" class="carousel slide my-4" data-ride="carousel">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img src="~/images/images2.jpg" class="d-block w-100" alt="Clase 1">
        </div>
        <div class="carousel-item">
            <img src="~/images/images8.jpg" class="d-block w-100" alt="Clase 2">
        </div>
        <div class="carousel-item">
            <img src="~/images/images4.jpg" class="d-block w-100" alt="Clase 3">
        </div>
        <div class="carousel-item">
            <img src="~/images/images5.jpg" class="d-block w-100" alt="Clase 4">
        </div>
        <div class="carousel-item">
            <img src="~/images/images6.jpg" class="d-block w-100" alt="Clase 5">
        </div>
        <div class="carousel-item">
            <img src="~/images/images7.jpg" class="d-block w-100" alt="Clase 7">
        </div>
        <div class="carousel-item">
            <img src="~/images/images3.jpg" class="d-block w-100" alt="Clase 8">
        </div>
    </div>
</div>

<!-- TODO: Que el buscador funcione -->
<div class="container my-4">
    <div class="row">
        <div class="col-md-6">
        <div class="input-group">
                <input type="text" class="form-control" placeholder="Buscar clase" />
                <div class="input-group-append">
                    <button class="btn btn-outline-light" type="submit">Buscar</button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" placeholder="Desde" />
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" placeholder="Hasta" />
        </div>
    </div>
</div>
<!-- Cards-->
<div class="container">
    <div id="activityContainer" class="row">
    </div>
</div>
<div class="card-Qr" id="prueba">
        <div class="card-body">
            <h5 class="card-title">Código de Acceso</h5>
            <p class="card-text">Escanea el código QR para acceder a la clase.</p>
            <div id="qrContainer"></div> 
            <button class="btn btn-primary mt-3" onclick="ocultarQR()">Cerrar</button>
        </div>
</div>
<div id="ocultar" style="display: none;">Contenido que se muestra/oculta con el QR</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        function mostrarQR() {
    console.log("Mostrando el QR...");
    $("#prueba").css("display", "block");
}

function ocultarQR() {
    console.log("Ocultando el QR...");
    $("#prueba").fadeOut(function() {
        $("#prueba").css("display", "none");
    });
}

        $(document).ready(function() {
            $.ajax({
                url: '/Home/GetActivities',
                method: 'GET',
                success: function(data) {
                    renderActivities(data);
                },
                error: function(error) {
                    console.error("Error al obtener actividades:", error);
                }
            });

            function renderActivities(activities) {
                const container = $("#activityContainer");
                container.empty(); // Limpiar antes de agregar actividades

                activities.forEach(activity => {
                    const card = `
                        <div class="col-md-4 mb-4">
                            <div class="card shadow-lg h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${activity.title}</h5>
                                    <p class="card-text"><img class="small-icon" src="/images/calendar.png" alt="Icono de Fecha"> Fecha: ${activity.date}</p>
                                    <p class="card-text"><img class="small-icon" src="/images/24.png"> Día: ${activity.day}</p>
                                    <p class="card-text"><img class="small-icon" src="/images/clock.png"> Hora: ${activity.time}</p>
                                    <p class="card-text"><img class="small-icon" src="/images/teacher.png"> Profesor: ${activity.teacher}</p>
                                    <p class="card-text"><img class="small-icon" src="/images/quota.png"> Cupo: <span class="quota" data-id="${activity.classId}">${activity.cupo}</span></p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-primary btn-inscribirse" data-id="${activity.classId}">Inscribirse</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
                $(".btn-inscribirse").on("click", function() {
                    const classId = $(this).data("id");
                    inscribirse(classId);
                });
            }

            // Función para inscribirse en la clase
            function inscribirse(classId) {
                if (!validarReserva()) {
                    alert("No se puede realizar la reserva. Verifica que tienes la cuota al día, cupo disponible y apto cargado.");
                    return;
                }

                // Enviar solicitud al backend para realizar la inscripción
                $.ajax({
                    url: '/Home/Inscribirse',  
                    method: 'POST',
                    data: { classId: classId },
                    success: function(response) {
                        alert(response.message); 
                        // Actualizar el cupo en la tarjeta correspondiente
                        const cupoElement = $(`.quota[data-id="${classId}"]`);
                        const currentCupo = parseInt(cupoElement.text(), 10);
                        if (!isNaN(currentCupo) && currentCupo > 0) {
                            cupoElement.text(currentCupo - 1); // Resta uno al cupo actual
                        }
                        const codigoQR = `<img src="https://api.qrserver.com/v1/create-qr-code/?data=AccesoClase_${classId}&size=200x200" alt="Código de acceso" title="Acceso Clase" />`;
                        $("#qrContainer").html(codigoQR); 
                        $("#prueba").show(); 
                    },
                    error: function(xhr) {
                        const errorMessage = xhr.responseJSON?.message || "Error al inscribirse.";
                        alert(errorMessage);
                    }
                });
            }

            function validarReserva() {
                var cuotaAlDia = verificarCuota();
                var aptoCargado = verificarApto();
                
                return cuotaAlDia && aptoCargado;
            }

            // Funciones de validación (puedes implementar estas lógicas)
            function verificarCuota() {
                $.ajax({
                    url: '/Home/GetUserPayment',  
                    method: 'GET',
                    async: false, 
                    success: function(response) {
                        if (response.success) {
                            console.log("Pago realizado: " + response.message);
                            pagoValido = true; 
                        } else {
                            alert(response.message);  
                            pagoValido = false;
                        }
                    },
                    error: function() {
                        alert("Hubo un error al verificar el pago.");
                        pagoValido = false;
                    }
                });
                return pagoValido;
            }

            function verificarApto() {
                $.ajax({
                    url: '/Home/GetUserApto',  
                    method: 'GET',
                    async: false, 
                    success: function(response) {
                        if (response.success) {
                            console.log("Condicion:" + response.message);
                            aptoValido = true; 
                        } else {
                            alert(response.message);  
                            aptoValido = false;
                        }
                    },
                    error: function() {
                        alert("Hubo un error al verificar el apto cargado.");
                        aptoValido = false;
                    }
                });
                return aptoValido;
            }
        });
    </script>
}
